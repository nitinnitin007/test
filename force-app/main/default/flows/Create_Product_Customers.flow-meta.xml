<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>49.0</apiVersion>
    <assignments>
        <name>Reset_RAC_Total_on_PC</name>
        <label>Reset RAC Total on PC</label>
        <locationX>619</locationX>
        <locationY>448</locationY>
        <assignmentItems>
            <assignToReference>RAC_Total</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Totaling_RAC_on_Existing_PC</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Totaling_RAC_on_Existing_PC</name>
        <label>Totaling RAC on Existing PC</label>
        <locationX>428</locationX>
        <locationY>447</locationY>
        <assignmentItems>
            <assignToReference>RAC_Total</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Iteration_Loop_variable.Recurring_Amount_Change__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>RAC_Total</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Existing_Product_Customer.Amount__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_PC_RAC</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Does_PC_exist_for_this_product_line</name>
        <label>Does PC exist for this product line</label>
        <locationX>755</locationX>
        <locationY>47</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Existing_Product_Customer</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_OPC_based_on_PC</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
        <rules>
            <name>No</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Existing_Product_Customer</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_New_PCs</targetReference>
            </connector>
            <label>No</label>
        </rules>
    </decisions>
    <description>Creates Product Customers</description>
    <formulas>
        <name>IDSHORT</name>
        <dataType>String</dataType>
        <expression>LEFT({!Iteration_Loop_variable.Product_LineNew__c},15)</expression>
    </formulas>
    <interviewLabel>Create Product Customers {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Create Product Customers</label>
    <loops>
        <description>Checks for all OPCs created per Product Line</description>
        <name>Loop_for_multiple_OPCs</name>
        <label>Loop for multiple OPCs</label>
        <locationX>329</locationX>
        <locationY>39</locationY>
        <assignNextValueToReference>Iteration_Loop_variable</assignNextValueToReference>
        <collectionReference>ListofOPCRecords</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Does_PC_Exist</targetReference>
        </nextValueConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_New_PCs</name>
        <label>Create New PCs</label>
        <locationX>700</locationX>
        <locationY>318</locationY>
        <assignRecordIdToReference>NewProductCustomer.Id</assignRecordIdToReference>
        <connector>
            <targetReference>Update_OPCs_with_PCs</targetReference>
        </connector>
        <inputAssignments>
            <field>Account__c</field>
            <value>
                <elementReference>AccountID</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Amount__c</field>
            <value>
                <elementReference>Iteration_Loop_variable.Recurring_Amount_Change__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>CSM__c</field>
            <value>
                <elementReference>Iteration_Loop_variable.TCSM__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>CurrencyIsoCode</field>
            <value>
                <elementReference>Iteration_Loop_variable.CurrencyIsoCode</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Customer_Lifecycle_Stage_I__c</field>
            <value>
                <stringValue>New Customer</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Customer_Lifecycle_Stage__c</field>
            <value>
                <stringValue>Project not started yet</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Product_LineNew__c</field>
            <value>
                <elementReference>IDSHORT</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Product_Line__c</field>
            <value>
                <elementReference>Iteration_Loop_variable.Product_Line__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Status__c</field>
            <value>
                <stringValue>Active</stringValue>
            </value>
        </inputAssignments>
        <object>Subscription__c</object>
    </recordCreates>
    <recordLookups>
        <description>Checks if PC exists for the OPC</description>
        <name>Does_PC_Exist</name>
        <label>Does PC Exist</label>
        <locationX>529</locationX>
        <locationY>49</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Does_PC_exist_for_this_product_line</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Account__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>AccountID</elementReference>
            </value>
        </filters>
        <filters>
            <field>Product_Line_New_Text__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Iteration_Loop_variable.Product_Line_New_Text__c</elementReference>
            </value>
        </filters>
        <object>Subscription__c</object>
        <outputReference>Existing_Product_Customer</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Amount__c</queriedFields>
        <sortField>Id</sortField>
        <sortOrder>Asc</sortOrder>
    </recordLookups>
    <recordLookups>
        <description>Creates Product Customer when an Opportunity is closed Won.</description>
        <name>Product_Customer_Create</name>
        <label>Product Customer - Create</label>
        <locationX>149</locationX>
        <locationY>48</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_for_multiple_OPCs</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Opportunity__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OpportunityID</elementReference>
            </value>
        </filters>
        <object>Opportunity_Product_Component__c</object>
        <outputReference>ListofOPCRecords</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Product_LineNew__c</queriedFields>
        <queriedFields>CurrencyIsoCode</queriedFields>
        <queriedFields>Recurring_Amount_Change__c</queriedFields>
        <queriedFields>Product_Line_New_Text__c</queriedFields>
        <queriedFields>Product_Line__c</queriedFields>
        <queriedFields>TCSM__c</queriedFields>
    </recordLookups>
    <recordUpdates>
        <description>Updates OPC because PC exists for an account</description>
        <name>Update_OPC_based_on_PC</name>
        <label>Update OPC based on PC</label>
        <locationX>776</locationX>
        <locationY>448</locationY>
        <connector>
            <targetReference>Reset_RAC_Total_on_PC</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Iteration_Loop_variable.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Product_Customer__c</field>
            <value>
                <elementReference>Existing_Product_Customer.Id</elementReference>
            </value>
        </inputAssignments>
        <object>Opportunity_Product_Component__c</object>
    </recordUpdates>
    <recordUpdates>
        <description>Link new Product Customer to source OPC (using Account + Product Line)</description>
        <name>Update_OPCs_with_PCs</name>
        <label>Update OPCs with PCs</label>
        <locationX>369</locationX>
        <locationY>311</locationY>
        <connector>
            <targetReference>Loop_for_multiple_OPCs</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Iteration_Loop_variable.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Product_Customer__c</field>
            <value>
                <elementReference>NewProductCustomer.Id</elementReference>
            </value>
        </inputAssignments>
        <object>Opportunity_Product_Component__c</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_PC_RAC</name>
        <label>Update_PC_RAC</label>
        <locationX>233</locationX>
        <locationY>450</locationY>
        <connector>
            <targetReference>Loop_for_multiple_OPCs</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Existing_Product_Customer.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Amount__c</field>
            <value>
                <elementReference>RAC_Total</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>CSM__c</field>
            <value>
                <elementReference>Iteration_Loop_variable.TCSM__c</elementReference>
            </value>
        </inputAssignments>
        <object>Subscription__c</object>
    </recordUpdates>
    <startElementReference>Product_Customer_Create</startElementReference>
    <status>Active</status>
    <variables>
        <name>AccountID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>Existing_Product_Customer</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Subscription__c</objectType>
    </variables>
    <variables>
        <name>Iteration_Loop_variable</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Opportunity_Product_Component__c</objectType>
    </variables>
    <variables>
        <name>ListofOPCRecords</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Opportunity_Product_Component__c</objectType>
    </variables>
    <variables>
        <description>Stores the ID of the newly created PC when one is not found</description>
        <name>NewProductCustomer</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Subscription__c</objectType>
    </variables>
    <variables>
        <name>OpportunityID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <description>Captures TCSM from Practice Object &gt; Practice Owner</description>
        <name>PracticeTCSM</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>Product_Customer_1</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Subscription__c</objectType>
    </variables>
    <variables>
        <name>ProductLineOLD</name>
        <dataType>Picklist</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>RAC_Total</name>
        <dataType>Currency</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <scale>2</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
</Flow>
